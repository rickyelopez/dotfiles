require("mason").setup()
require("mason-lspconfig").setup({
    automatic_installation = { exclude = { "clangd" } },
    ensure_installed = {
        "jsonls",
        "yamlls",
        "sumneko_lua",
        "bashls",
        "pyright",
        "clangd",
        "vimls",
        "taplo",
    },
})

require("nvim-semantic-tokens").setup({
    preset = "clangd",
})

local util = require("lspconfig.util")

-- Mappings.
-- See `:help vim.diagnostic.*` for documentation on any of the below functions
local opts = { noremap = true, silent = true }
vim.keymap.set("n", "<space>e", vim.diagnostic.open_float, opts)
vim.keymap.set("n", "[c", vim.diagnostic.goto_prev, opts)
vim.keymap.set("n", "]c", vim.diagnostic.goto_next, opts)
vim.keymap.set("n", "<leader>cr", "<cmd>LspRestart<CR>", opts)
-- vim.keymap.set('n', '<space>q', vim.diagnostic.setloclist, opts)

-- Use an on_attach function to only map the following keys
-- after the language server attaches to the current buffer
local on_attach = function(client, bufnr)
    -- Enable completion triggered by <c-x><c-o>
    vim.api.nvim_buf_set_option(bufnr, "omnifunc", "v:lua.vim.lsp.omnifunc")

    -- Mappings.
    -- See `:help vim.lsp.*` for documentation on any of the below functions
    local bufopts = { noremap = true, silent = true, buffer = bufnr }
    vim.keymap.set("n", "gD", vim.lsp.buf.declaration, bufopts)
    vim.keymap.set("n", "gd", vim.lsp.buf.definition, bufopts)
    vim.keymap.set("n", "gi", vim.lsp.buf.implementation, bufopts)
    vim.keymap.set("n", "gr", vim.lsp.buf.references, bufopts)
    vim.keymap.set("n", "K", vim.lsp.buf.hover, bufopts)
    vim.keymap.set("n", "<C-k>", vim.lsp.buf.signature_help, bufopts)
    vim.keymap.set("n", "<space>wa", vim.lsp.buf.add_workspace_folder, bufopts)
    vim.keymap.set("n", "<space>wr", vim.lsp.buf.remove_workspace_folder, bufopts)
    vim.keymap.set("n", "<space>wl", function()
        print(vim.inspect(vim.lsp.buf.list_workspace_folders()))
    end, bufopts)
    vim.keymap.set("n", "<space>D", vim.lsp.buf.type_definition, bufopts)
    vim.keymap.set("n", "<space>rn", vim.lsp.buf.rename, bufopts)
    vim.keymap.set("n", "<space>ca", vim.lsp.buf.code_action, bufopts)
    if client.name and client.name == "clangd" then
        vim.keymap.set("n", "<leader>o", "<cmd>ClangdSwitchSourceHeader<CR>", bufopts)
    else
        -- don't define leader f in clangd
        vim.keymap.set("n", "<leader>f", function()
            vim.lsp.buf.format({ async = true })
        end, bufopts)
    end

    local caps = client.server_capabilities
    if caps.semanticTokensProvider and caps.semanticTokensProvider.full then
        local augroup = vim.api.nvim_create_augroup("SemanticTokens", {})
        vim.api.nvim_create_autocmd("TextChanged", {
            group = augroup,
            buffer = bufnr,
            callback = function()
                vim.lsp.buf.semantic_tokens_full()
            end,
        })
        -- fire it first time on load as well
        vim.lsp.buf.semantic_tokens_full()
    end
end

local lsp_flags = {
    -- This is the default in Nvim 0.7+
    debounce_text_changes = 150,
}

local capabilities = require("cmp_nvim_lsp").default_capabilities()

require("mason-lspconfig").setup_handlers({
    -- The first entry (without a key) will be the default handler
    -- and will be called for each installed server that doesn't have
    -- a dedicated handler.
    function(server_name) -- default handler (optional)
        require("lspconfig")[server_name].setup({
            on_attach = on_attach,
            flags = lsp_flags,
            capabilities = capabilities,
        })
    end,
    ["sumneko_lua"] = function()
        require("lspconfig")["sumneko_lua"].setup({
            on_attach = on_attach,
            flags = lsp_flags,
            capabilities = capabilities,
            settings = {
                Lua = {
                    diagnostics = {
                        -- Get the language server to recognize the `vim` global
                        globals = { "vim" },
                    },
                    -- Do not send telemetry data containing a randomized but unique identifier
                    telemetry = {
                        enable = false,
                    },
                },
            },
        })
    end,
    ["pyright"] = function()
        require("lspconfig")["pyright"].setup({
            on_attach = on_attach,
            flags = lsp_flags,
            capabilities = capabilities,
            root_dir = util.root_pattern(unpack({ "pyproject.toml" })),
        })
    end,
})

require("clangd_extensions").setup({
    server = {
        on_attach = on_attach,
        flags = lsp_flags,
        capabilities = capabilities,
    },
    extensions = {
        -- defaults:
        -- Automatically set inlay hints (type hints)
        autoSetHints = true,
        -- These apply to the default ClangdSetInlayHints command
        inlay_hints = {
            -- Only show inlay hints for the current line
            only_current_line = false,
            -- Event which triggers a refersh of the inlay hints.
            -- You can make this "CursorMoved" or "CursorMoved,CursorMovedI" but
            -- note that this may cause  higher CPU usage.
            -- This option is only respected when only_current_line and
            -- autoSetHints both are true.
            only_current_line_autocmd = "CursorHold",
            -- whether to show parameter hints with the inlay hints or not
            show_parameter_hints = true,
            -- prefix for parameter hints
            parameter_hints_prefix = "<- ",
            -- prefix for all the other hints (type, chaining)
            other_hints_prefix = "=> ",
            -- whether to align to the length of the longest line in the file
            max_len_align = false,
            -- padding from the left if max_len_align is true
            -- max_len_align_padding = 1,
            -- whether to align to the extreme right or not
            right_align = false,
            -- padding from the right if right_align is true
            -- right_align_padding = 7,
            -- The color of the hints
            highlight = "Comment",
            -- The highlight group priority for extmark
            priority = 100,
        },
        ast = {
            -- These are unicode, should be available in any font
            role_icons = {
                type = "üÑ£",
                declaration = "üÑì",
                expression = "üÑî",
                statement = ";",
                specifier = "üÑ¢",
                ["template argument"] = "üÜÉ",
            },
            kind_icons = {
                Compound = "üÑ≤",
                Recovery = "üÖÅ",
                TranslationUnit = "üÖÑ",
                PackExpansion = "üÑø",
                TemplateTypeParm = "üÖÉ",
                TemplateTemplateParm = "üÖÉ",
                TemplateParamObject = "üÖÉ",
            },
            --[[ These require codicons (https://github.com/microsoft/vscode-codicons)
            role_icons = {
                type = "Ó≠£",
                declaration = "Ó™å",
                expression = "Ó©±",
                specifier = "ÓÆÜ",
                statement = "Ó™Ü",
                ["template argument"] = "Ó™í",
            },

            kind_icons = {
                Compound = "Ó™ã",
                Recovery = "Ó™á",
                TranslationUnit = "Ó´©",
                PackExpansion = "Ó©º",
                TemplateTypeParm = "Ó™í",
                TemplateTemplateParm = "Ó™í",
                TemplateParamObject = "Ó™í",
            }, ]]

            highlights = {
                detail = "Comment",
            },
        },
        memory_usage = {
            border = "none",
        },
        symbol_info = {
            border = "none",
        },
    },
})
